name: Build Docker image
description: Build a Docker image and optionally upload it as artifact

inputs:
  context:
    description: The build's context
    required: false
    default: .
  file:
    description: Path to the Dockerfile to build
    required: false
    default: Dockerfile
  build-args:
    description: The arguments to build the image with
    required: false
  target:
    description: The target stage to build
    required: false
  name:
    description: The name to call the image
    required: true
  upload:
    description: Whether to upload the image as artifact
    required: false
    default: 'true'

runs:
  using: composite
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@4b4e9c3e2d4531116a6f8ba8e71fc6e2cb6e6c8c # v2.5.0

    - name: Build image
      uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671 # v4.0.0
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.file }}
        build-args: |
          ${{ inputs.build-args }}
        cache-from: type=gha,scope=${{ github.ref_name }}-${{ inputs.file }}-${{ inputs.target || 'main' }}
        cache-to: type=gha,mode=max,scope=${{ github.ref_name }}-${{ inputs.file }}-${{ inputs.target || 'main' }}
        tags: |
          ${{ inputs.name }}
        target: ${{ inputs.target }}
        outputs: type=docker,dest=/tmp/${{ inputs.name }}.tar

    - name: Upload artifact
      if: fromJSON(inputs.upload)
      uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # v3.1.2
      with:
        name: ${{ inputs.name }}
        path: /tmp/${{ inputs.name }}.tar
